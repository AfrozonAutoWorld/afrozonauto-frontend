"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[980],{2980:function(e,t,r){r.d(t,{G:function(){return m},u:function(){return p}});var s=r(9827),n=r(1713),o=r(1770),a=r(9376),i=r(6305);let u={startRegistration:async e=>i.x.post("/auth/register-start",e),verifyCode:async e=>i.x.post("/auth/verify",e),signUp:async e=>i.x.post("/auth/register",e),signIn:async e=>i.x.post("/auth/login",e),getUserById:async e=>i.x.get("/auth/users/user-id/".concat(e)),updateProfile:async e=>i.x.patch("/auth/profile",e),forgotPassword:async e=>i.x.post("/auth/forgot-password",e),resetPassword:async e=>i.x.post("/auth/reset-password",e)};var c=r(999),l=r(4191),d=r(2265),f=r(3464);let h=r(257).env.NEXT_PUBLIC_API_BASE_URL,g=["/dashboard","/request-details"];function m(){let e=(0,s.NL)(),t=(0,a.usePathname)(),r=(0,a.useRouter)(),{setAuth:f,clearAuth:h,isAuthenticated:m,user:p,isHydrated:y,isInitialized:v,setInitialized:w}=(0,l.tN)(),k=g.some(e=>t.startsWith(e)),{data:P,isLoading:A,error:I,refetch:E}=(0,n.a)({queryKey:["auth","user-id"],queryFn:async()=>{try{if(null==p?void 0:p.id)return await u.getUserById(p.id);return null}catch(e){if(console.error("Failed to fetch user:",e),e instanceof i.M&&(401===e.status||403===e.status))return console.warn("Authentication failed, clearing auth"),h(),null;return p}},enabled:y&&m&&k&&!!(null==p?void 0:p.id),retry:1,staleTime:3e5,refetchOnMount:!1,refetchOnWindowFocus:!1});(0,d.useEffect)(()=>{P&&P!==p&&l.tN.setState({user:P,isAuthenticated:!0,isHydrated:!0,isInitialized:!0})},[P,p]),(0,d.useEffect)(()=>{y&&!v&&w(!0)},[y,v,w]);let S=()=>{h(),e.removeQueries({queryKey:["auth","user-id"]}),r.replace("/login")},N=(0,o.D)({mutationFn:e=>u.signIn(e),onSuccess:t=>{var r;if(t.success&&(null===(r=t.data)||void 0===r?void 0:r.data)){let{user:r,accessToken:s,refreshToken:n}=t.data.data;f(r,s,n),e.setQueryData(["auth","user-id"],r),(0,c.C)({type:"success",message:"Welcome back, ".concat(r.fullName||r.email,"!")})}},onError:e=>{console.error("Sign in error:",e),(0,c.C)({type:"error",message:e.message||"Login failed. Please check your credentials."})}}),C=(0,o.D)({mutationFn:e=>u.startRegistration(e),onSuccess:(e,t)=>{sessionStorage.setItem("onboarding_email",t.email),(0,c.C)({type:"success",message:"Verification code sent to your email!"})},onError:e=>{var t;let r=(null===(t=e.errors)||void 0===t?void 0:t[0])||e.message||"Failed to send verification code";(0,c.C)({type:"error",message:r})}}),T=(0,o.D)({mutationFn:e=>u.verifyCode(e),onSuccess:(e,t)=>{sessionStorage.setItem("verified_email",t.email),sessionStorage.removeItem("onboarding_email"),(0,c.C)({type:"success",message:"Email verified successfully!"})},onError:e=>{var t;let r=(null===(t=e.errors)||void 0===t?void 0:t[0])||e.message||"Verification failed";(0,c.C)({type:"error",message:r})}}),R=(0,o.D)({mutationFn:e=>{var t;let r="".concat(e.firstName," ").concat(e.lastName).trim();return u.signUp({email:e.email,password:e.password,firstName:e.firstName,lastName:e.lastName,fullName:r,phone:e.phone,role:null!==(t=e.role)&&void 0!==t?t:"BUYER",isActive:!0})},onSuccess:()=>{sessionStorage.removeItem("verified_email"),(0,c.C)({type:"success",message:"Account created successfully! Please login."})},onError:e=>{(0,c.C)({type:"error",message:e.message||"Failed to complete profile"})}}),b=(0,o.D)({mutationFn:e=>u.forgotPassword(e),onSuccess:(e,t)=>{sessionStorage.setItem("reset_email",t.email),(0,c.C)({type:"success",message:"Password reset code sent to your email!"})},onError:e=>{console.error("Forgot password error:",e),(0,c.C)({type:"error",message:e.message||"Failed to send reset code",duration:4e3})}}),F=(0,o.D)({mutationFn:e=>{let{confirmPassword:t,...r}=e;return u.resetPassword(r)},onSuccess:()=>{sessionStorage.removeItem("reset_email"),(0,c.C)({type:"success",message:"Password changed successfully. Please login again."}),S()},onError:e=>{console.error("Reset password error:",e),(0,c.C)({type:"error",message:e.message||"Failed to reset password"})}}),_=(0,o.D)({mutationFn:e=>u.updateProfile(e),onSuccess:t=>{let{user:r,updateUser:s}=l.tN.getState();if(r){let n={...r,...t};s(n),e.setQueryData(["auth","user-id"],n)}(0,c.C)({type:"success",message:"Profile updated successfully!"})},onError:e=>{console.error("Update profile error:",e),(0,c.C)({type:"error",message:e.message||"Failed to update profile"})}}),x=void 0!==P?P:p;return{user:x,loading:A||!v,error:I,isAuthenticated:m&&!!x,refetchUser:E,onboarding:C.mutateAsync,verify:T.mutateAsync,completeProfile:R.mutateAsync,signIn:N.mutateAsync,forgotPassword:b.mutateAsync,resetPassword:F.mutateAsync,signOut:()=>{h(),e.removeQueries({queryKey:["auth","user"]}),r.replace("/")},updateProfile:_.mutateAsync,isOnboarding:C.isPending,isVerifying:T.isPending,isCompletingProfile:R.isPending,isSigningIn:N.isPending,isForgettingPassword:b.isPending,isResettingPassword:F.isPending,isUpdatingProfile:_.isPending,signInError:N.error,onboardingError:C.error,verifyError:T.error,completeProfileError:R.error,forgotPasswordError:b.error,resetPasswordError:F.error,updateProfileError:_.error}}function p(){let{accessToken:e,refreshToken:t,setAuth:r,user:s,clearAuth:n,isAuthenticated:o}=(0,l.tN)(),a=(0,d.useRef)(null),i=(0,d.useRef)(!1),u=(0,d.useRef)(0);return(0,d.useEffect)(()=>{if(!o||!e||!t){a.current&&(clearInterval(a.current),a.current=null);return}let c=async()=>{if(i.current)return;let o=Date.now();if(!(o-u.current<3e4)&&(0,l.Rm)(e,300))try{i.current=!0,u.current=o;let{accessToken:e,refreshToken:n}=(await f.Z.post("".concat(h,"/auth/refresh-token"),{refreshToken:t},{headers:{"Content-Type":"application/json"},timeout:1e4})).data.data;if(!s){console.error("User object missing during refresh");return}r(s,e,n)}catch(e){if(console.error("❌ Background token refresh failed:",e),f.Z.isAxiosError(e)){var a;let t=null===(a=e.response)||void 0===a?void 0:a.status;(401===t||403===t)&&(console.warn("Refresh token invalid, logging out user"),n())}}finally{i.current=!1}};return c(),a.current=setInterval(c,12e4),()=>{a.current&&clearInterval(a.current),i.current=!1}},[e,t,s,r,n,o]),null}},6305:function(e,t,r){r.d(t,{M:function(){return a},x:function(){return u}});var s=r(3464),n=r(4191);let o=r(257).env.NEXT_PUBLIC_API_BASE_URL;class a extends Error{constructor(e,t,r,s,n,o){super(e),this.status=t,this.code=r,this.errors=s,this.details=n,this.data=o,this.name="ApiError"}}class i{setupInterceptors(){this.client.interceptors.request.use(async e=>{var t;let{accessToken:r,isAuthenticated:a,refreshToken:i}=n.tN.getState();if(null===(t=e.url)||void 0===t?void 0:t.includes("/auth/refresh-token"))return e;if(a&&r){if((0,n.Rm)(r,60)&&i&&!this.isRefreshing)try{this.isRefreshing=!0;let{accessToken:t,refreshToken:r}=(await s.Z.post("".concat(o,"/auth/refresh-token"),{token:i},{headers:{"Content-Type":"application/json"},timeout:1e4})).data.data;n.tN.getState().setAuth(n.tN.getState().user,t,r),e.headers.Authorization="Bearer ".concat(t)}catch(t){console.error("❌ API Interceptor: Proactive token refresh failed:",t),e.headers.Authorization="Bearer ".concat(r)}finally{this.isRefreshing=!1}else e.headers.Authorization="Bearer ".concat(r)}return e},e=>Promise.reject(e)),this.client.interceptors.response.use(e=>e,async e=>{var t;let r=e.config;if((null===(t=e.response)||void 0===t?void 0:t.status)===401&&!r._retry){if(this.isRefreshing)return new Promise((e,t)=>{this.failedQueue.push({resolve:e,reject:t})}).then(()=>{let{accessToken:e}=n.tN.getState();return r.headers&&e&&(r.headers.Authorization="Bearer ".concat(e)),this.client(r)}).catch(e=>Promise.reject(e));r._retry=!0,this.isRefreshing=!0;try{let{refreshToken:e}=n.tN.getState();if(!e)throw console.warn("⚠️ API Interceptor: No refresh token available for 401 retry"),Error("No refresh token available");let{accessToken:t,refreshToken:a}=(await s.Z.post("".concat(o,"/auth/refresh-token"),{token:e},{headers:{"Content-Type":"application/json"},timeout:1e4})).data.data;return n.tN.getState().setAuth(n.tN.getState().user,t,a),this.processQueue(null),r.headers&&(r.headers.Authorization="Bearer ".concat(t)),this.client(r)}catch(e){return console.error("❌ API Interceptor: Token refresh failed after 401:",e),this.processQueue(e),this.handleLogout(),Promise.reject(this.transformError(e))}finally{this.isRefreshing=!1}}return Promise.reject(this.transformError(e))})}transformError(e){if(e.response){let{data:t,status:r}=e.response;return new a((null==t?void 0:t.message)||"Request failed with status ".concat(r),r,null==t?void 0:t.code,null==t?void 0:t.errors,null==t?void 0:t.details,t)}return"ECONNABORTED"===e.code?new a("Request timeout",0):new a(e.message||"Network error",0)}processQueue(e){this.failedQueue.forEach(t=>{e?t.reject(e):t.resolve()}),this.failedQueue=[]}handleLogout(){let{clearAuth:e}=n.tN.getState();e();{let e=window.location.pathname;["/dashboard","/request-details"].some(t=>e.startsWith(t))&&(window.location.href="/login")}}async get(e,t){return(await this.client.get(e,t)).data}async post(e,t,r){return(await this.client.post(e,t,r)).data}async put(e,t,r){return(await this.client.put(e,t,r)).data}async patch(e,t,r){return(await this.client.patch(e,t,r)).data}async delete(e,t){return(await this.client.delete(e,t)).data}constructor(e){this.isRefreshing=!1,this.failedQueue=[],this.client=s.Z.create({baseURL:e,headers:{"Content-Type":"application/json"},timeout:15e3}),this.setupInterceptors()}}let u=new i(o)},4191:function(e,t,r){r.d(t,{Rm:function(){return a},mc:function(){return o},tN:function(){return u}});var s=r(3011),n=r(6885);function o(e){if(!e)return!0;try{let t=e.split(".");if(3!==t.length)return!0;let r=JSON.parse(atob(t[1]));if(!r.exp)return!1;let s=Math.floor(Date.now()/1e3);return r.exp<s}catch(e){return console.error("Error decoding token:",e),!0}}function a(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:60;if(!e)return!0;try{let r=e.split(".");if(3!==r.length)return!0;let s=JSON.parse(atob(r[1]));if(!s.exp)return!1;let n=Math.floor(Date.now()/1e3);return s.exp<n+t}catch(e){return console.error("Error decoding token:",e),!0}}let i={getItem:e=>{let t=localStorage.getItem(e);return t?JSON.parse(t):null},setItem:(e,t)=>{localStorage.setItem(e,JSON.stringify(t))},removeItem:e=>{localStorage.removeItem(e)}},u=(0,s.U)()((0,n.tJ)((e,t)=>({user:null,accessToken:null,refreshToken:null,isAuthenticated:!1,isHydrated:!1,isInitialized:!1,setAuth:(t,r,s)=>{e({user:t,accessToken:r,refreshToken:s||null,isAuthenticated:!0,isHydrated:!0,isInitialized:!0})},updateUser:t=>e(e=>({...e,user:t})),setAccessToken:t=>e({accessToken:t}),clearAuth:()=>{e({user:null,accessToken:null,refreshToken:null,isAuthenticated:!1,isHydrated:!0,isInitialized:!0})},setHydrated:t=>e({isHydrated:t}),setInitialized:t=>e({isInitialized:t}),isTokenExpired:()=>{let{accessToken:e}=t();return o(e)}}),{name:"auth-storage",storage:(0,n.FL)(()=>i),partialize:e=>({user:e.user,accessToken:e.accessToken,refreshToken:e.refreshToken,isAuthenticated:e.isAuthenticated}),onRehydrateStorage:()=>e=>{if(e&&(e.isHydrated=!0,e.isAuthenticated&&e.accessToken)){let t=o(e.accessToken),r=!!e.refreshToken;t&&!r&&(console.warn("Token expired and no refresh token available, clearing auth"),e.user=null,e.accessToken=null,e.refreshToken=null,e.isAuthenticated=!1)}}}))},999:function(e,t,r){r.d(t,{C:function(){return n}});var s=r(4438);let n=e=>{let{type:t,message:r,duration:n=2e3,position:o="top-center"}=e,a={color:"#fff"},i={success:"#4CAF50",error:"#FF5722",info:"#2196F3",warning:"#FFC107"};switch(s.Am.dismiss(),t){case"success":s.Am.success(r,{duration:n,style:{...a,backgroundColor:i.success},position:o});break;case"error":s.Am.error(r,{duration:n,style:{...a,backgroundColor:i.error},position:o});break;case"info":(0,s.Am)(r,{duration:n,style:{...a,backgroundColor:i.info},position:o});break;case"warning":(0,s.Am)(r,{duration:n,style:{...a,backgroundColor:i.warning},position:o});break;default:console.warn("Invalid toast type")}}}}]);